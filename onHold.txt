version: "3.9"

services:

  postgres:
    #container_name: sd_postgres
    image: postgres
    environment:
      - POSTGRES_DB=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - TZ=Europe/London
    volumes:
      - ./data/db:/var/lib/postgresql/data
    #networks:
    #  - app-network

  backend:
    depends_on:
      - postgres
    #container_name: sd_backend
    build: 
      context: .
      dockerfile: ./dockerfiles/backend/Dockerfile
    env_file: .env
    environment:
      - TZ=Europe/London
    volumes:
      - ./core:/src/core
      - ./web:/src/web
      - ./libraries:/src/libraries
      - ./nginx:/etc/nginx/sites-available
      - ./uwsgi/vassals:/etc/uwsgi/vassals
      - ./socket:/socket
      #- wordpress:/var/www/html
    ports:
      - "8080:8080"
      - "80:80"
      - "443:443"
    #networks:
    #  - app-network
    command: python /src/core/startUp.py
    #command: tail -F anything 
  
 

 
 db:
    image: mysql:8.0
    #container_name: db
    restart: unless-stopped
    env_file: .env
    environment:
      - MYSQL_DATABASE=wordpress
    volumes:
      - dbdata:/var/lib/mysql
    command: '--default-authentication-plugin=mysql_native_password'
    networks:
      - app-network

  wordpress:
    depends_on:
      - db
      - backend
    image: wordpress:5.1.1-fpm-alpine
    #container_name: wordpress
    restart: unless-stopped
    env_file: .env
    environment:
      - WORDPRESS_DB_HOST=db:3306
      - WORDPRESS_DB_USER=$MYSQL_USER
      - WORDPRESS_DB_PASSWORD=$MYSQL_PASSWORD
      - WORDPRESS_DB_NAME=wordpress
    volumes:
      - wordpress:/var/www/html
    networks:
      - app-network

volumes:
  wordpress:
  dbdata:

#networks:
#  app-network:
#    driver: bridge 
 


 ##########################






# linux socket to connect nginx and uwsgi. uwsgi then connects to django
upstream django {
    server unix:///socket/nginx_uwsgi.sock;
}

# configuration of the http server (not secure)
server {
    listen      80;
    server_name spiritumduo.com www.spiritumduo.com;
    charset     utf-8;

    # max upload size
    #client_max_body_size 75M;

    # Django media and static files
    location /media  {
        alias /src/web/media;
    }

    location /static {
        alias /src/web/static;
    }

    # Send all non-media requests to the Django server.
    location /app {
        uwsgi_pass  django;
        include     /socket/uwsgi_params;
    }

    #
    # NEW NEW NEW NEW
    #

    #index index.php index.html index.htm;

    #root /var/www/html;



    location ~ /blog/.*\.php$ {
        index index.php index.html index.htm;
        root /var/www/html;
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass wordpress:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    location /blog {
        root /var/www/html;
        try_files $uri $uri/ /index.php$is_args$args;
    }

    #location ~ /\.ht {
    #        deny all;
    #}

    #location = /favicon.ico {
    #        log_not_found off; access_log off;
    #}

    #location = /robots.txt {
    #        log_not_found off; access_log off; allow all;
    #}
    
    #location ~* \.(css|gif|ico|jpeg|jpg|js|png)$ {
    #        expires max;
    #        log_not_found off;
    #}
}